#!/bin/bash

echo -ne "4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA
4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA
4qCA4qCA4qCA4qCA4qOA4qGA4qCA4qCA4qCA4qKA4qKA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA
4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCACuKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKg
gOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKigOKjoOKj
pOKjtOKjtuKjtuKjtuKjpuKjpOKjpOKjpOKjpOKjtuKjvuKjv+Kjv+Kjv+Khl+KgsuKgsuKgv+Kg
v+Kgv+Kgt+KgpuKgpOKjpOKhgOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggAriooDio6Ti
o7bio6bioKTioKTio4Tio4Dio4Dio4Dio4DioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDi
oIDioIDioIDioIDioIDioqDioJ/iooniob3ioJ/ioJvioJvioJvioJvio7viob/ioLfio4TioIji
or/ioIDioLjioYbioYfioIDioIDioIDioIDioIDioIDioIDioIDioIjioqfioIDioIDioIDioIDi
oIDioIDioIDioIDioIDioIAK4qC44qO/4qO/4qG/4qCA4qCA4qCA4qCA4qCA4qCA4qCI4qCJ4qCJ
4qCJ4qCZ4qCS4qCS4qCS4qCS4qCg4qCk4qCk4qCk4qOE4qOA4qOw4qOv4qO04qOv4qOk4qOE4qOA
4qOg4qCW4qCL4qCB4qCA4qCA4qK44qCA4qO+4qCA4qKA4qO34qO44qCA4qOk4qOk4qOE4qOg4qO2
4qGE4qO24qOm4qC44qGE4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCACuKggOKgiOKgieKgmeKg
k+KgkuKgkuKgsuKgpOKgpOKgpOKipOKjgOKjgOKjgOKggOKggOKggOKggOKggOKggOKggOKggOKg
gOKggOKggOKgiOKgmeKjv+KjhuKggOKgiOKgs+KhhOKggOKggOKggOKggOKiuOKggOKhh+KggOKi
u+KiueKhgOKggOKjv+KhhOKiu+Kjv+KjhOKju+Kjv+KhmOKjp+Kiu+KggOKggOKggOKggOKggOKg
gOKggOKggOKggArioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDi
oInioInioInioJHioJLioJLioJLioKbio6Tio6Tio6Tio4DiobTio7/ioI/ioIDioIDiooDioIfi
oIDioIDioIDioIDioYbiorjioIfioIDioIjioJvioZ/ioobioJjio6fioIjio7/iornio7viob/i
orfio73ioIjio6fio4Tio4Dio4Dio4Dio4DioIDioIDioIAK4qCA4qCA4qCA4qCA4qCA4qCA4qCA
4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qO04qOL4qOA4qCI
4qO/4qOa4qOT4qOS4qOS4qOa4qOJ4qCy4qOk4qOE4qOA4qOw4qO34qCf4qCA4qCA4qCA4qCA4qK5
4qK44qCA4qCZ4qK/4qOf4qOI4qO/4qCn4qCk4qCd4qCS4qCL4qCJ4qCB4qCA4qCI4qO/4qGE4qCA
4qCACuKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKigOKjpOKgtuKg
tuKituKjv+Kjv+Kjv+Kjv+KjveKjv+Kju+Kjv+Kjv+Kjm+Kju+Kjv+Kiv+Kjv+Kjn+Kjv+Kjv+Kj
v+Kjv+Kjv+KgluKgkuKjsuKjtuKjtuKgvuKgtuKgk+Kgi+KgieKgieKggOKggOKggOKggOKggOKg
gOKggOKggOKggOKggOKggOKimOKhhuKggOKggArioIDioIDioIDioIDioIDioIDioIDioIDioIDi
oIDioIDioIDiooDio7Tiob/ioIHio4Dio7Tio4vioInio7nioYfio6Dio7/ioL/io7/ioZ/ioIni
oInioInioIHioInioInioInioInio5vioZvioJvio7/iopvio7/io7/ioYTioIDioIDioIDioIDi
oIDioIDioIDioIDioIDiooDio4Dio4DioaTioKTiorTio7bio77io5/iob3ioL/ioqTio4AK4qCA
4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qKA4qG04qCL4qCB4qCY4qCb4qK74qO/4qO/4qC1
4qKr4qO+4qG/4qCB4qCA4qO/4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qK64qO/4qO/4qGP4qK5
4qC44qO/4qO/4qOD4qOA4qOg4qOk4qC04qCW4qCS4qCS4qO/4qOP4qOp4qCk4qC+4qK34qOW4qOJ
4qOJ4qOJ4qO34qG24qCW4qKa4qO/CuKggOKggOKggOKigOKjtOKgnuKgieKgieKgieKgieKiieKh
veKgm+Kjs+KhtuKgguKggOKggOKjoOKjvOKhv+Kgi+KggOKggOKggOKjv+KhgOKggOKggOKggOKg
gOKggOKggOKggOKggOKjv+KggeKgieKjv+Khj+KgieKgieKigOKjgOKgrOKiv+KjtuKhkuKgiuKg
ieKgieKimeKjv+KjpuKhpOKglOKgm+Kjv+KgieKigOKjtOKjt+KjvuKjv+KjvwrioIDioIDioIDi
o77ioIHioIDioIDioIDioIDiobDioIvio4Dio7TioZ/ioIHioIDioqDio77io7/io4/io4Dio4Di
o4Dio4Dio4Dio7/ioYfioIDioIDio6DioL7ioJvioInioInioInioJDiopLiob7ioJvioLPio4Ti
oYDioIDioIDioIDio4Dio4nior/iobbioJLioIvioInioIDio7/ioYTio4Dio7Tio7/io77io7/i
o7/io7/io7/io7/iorkK4qCA4qCA4qCA4qK34qOE4qOA4qOA4qOA4qOA4qGH4qO84qO/4qGf4qCA
4qCg4qOk4qCA4qCJ4qCJ4qGJ4qOJ4qGJ4qCJ4qCb4qCb4qC/4qCH4qCA4qOw4qCL4qCA4qCA4qCA
4qCA4qCA4qKg4qCL4qCA4qCA4qKA4qGg4qCd4qK34qCK4qCJ4qCB4qCA4qCA4qOn4qCA4qCA4qOg
4qO04qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qCH4qCACuKggOKggOKggOKggOKiiOKj
v+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+KjjeKgieKgu+KgtuKgtuKjvuKgpuKgpOKgrOKjv+KjhOKj
gOKjvOKjsuKjvuKhv+KggOKggOKggOKggOKggOKggOKhh+KggOKjoOKgnuKiieKjoOKjpOKjvuKj
t+KjtuKjtuKjpuKjpOKjv+KjvuKjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Khv+Kg
n+KggOKggArioIDioIDioIDioIDioJjio7/io7/io7/io7/io7/io7/io7/io6fioInioLPio4Ti
oIDioIDioIDioIDioIDioIDioIDioInioInioJviornio7/ior/io7bio6Tio6Tio6Tio4Tio6Ti
oYHiorDioIPio7Tio7/io7/io7/ioJvio7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/i
o77iob/io7/io7/iob/ioJ/ioInioIDioIDioIDioIAK4qCA4qCA4qCA4qCA4qCA4qCY4qK/4qO/
4qO/4qO/4qO/4qO/4qO/4qO34qO24qO+4qO34qO24qO24qO24qOk4qOk4qOk4qOE4qOA4qOA4qOA
4qCA4qCA4qC54qO/4qO/4qO/4qO/4qO/4qO/4qO/4qO+4qO/4qO/4qK44qO/4qO/4qO/4qO/4qO/
4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qC/4qOv4qO/4qCf4qCJ4qCA4qCA4qCA4qCA4qCA4qCA4qCA
CuKggOKggOKggOKggOKggOKggOKggOKgiOKgm+Kgv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kj
v+Kjv+Khv+Kgn+KgieKggOKggOKggOKgiOKgieKgieKgmeKiv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kj
v+Kjv+Kjv+KjvOKjv+Kiv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kjv+Kgv+Kgi+KggOKg
gOKggOKggOKggOKggOKggOKggOKggOKggArioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDi
oIDioInioInioJvioJvioJvioJvioJvioJvioIHioIDioIDioIDioIDioIDioIDioIDioIDioIDi
oIDioIjioJnioL/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/io7/i
o7/io7/ioJ/ioIvioIHioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIDioIAK4qCA4qCA
4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA
4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCI4qCZ4qC/4qK/4qO/4qO/4qO/
4qO/4qO/4qO/4qO/4qO/4qO/4qO/4qCf4qCL4qCB4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA4qCA
4qCA4qCA4qCA4qCA4qCA4qCACuKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKg
gOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKg
gOKggOKggOKggOKggOKggOKggOKgieKgieKgieKgm+Kgm+Kgu+Kgn+Kgi+KggOKggOKggOKggOKg
gOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggOKggAo=
" | base64 -d


# Define services in format: name:port:protocol:plugin1,plugin2
SERVICES=(
    "telnet:23:TCP:telnet-ntlm-info"
    "ssh:22:TCP:ssh2-enum-algos"
    "msrpc:135:TCP:msrpc-enum"
    "nbstat:137:UDP:nbstat"
    "ldap:389:TCP:ldap-rootdse"
    "http:80:TCP:http-headers"
    "ssl:443:TCP:ssl-enum-ciphers"
    "wsman:5985:TCP:http-headers"
    "mssql:1433:TCP:ms-sql-info,ms-sql-dac,ms-sql-ntlm-info"
    "nfs:2049:UDP:nfs-ls,nfs-showmount,nfs-statfs"
    "mysql:3306:TCP:mysql-empty-password,mysql-enum,mysql-variables"
    "postgresql:5432:TCP:pgsql-brute"
    "oracle:1521:TCP:oracle-tns-version"
    "rpcbind:111:TCP:rpc-grind"
    "finger:79:TCP:fingerprint-strings"
    "rexec:512:TCP:rexec-brute"
    "vnc:5900:TCP:vnc-brute,vnc-title,realvnc-auth-bypass"
    "snmp:161:UDP:snmp-sysdescr"
)

# Validate IP or CIDR notation
validate_ip_or_cidr() {
    local input="$1"
    if [[ $input =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}$ ]] || [[ $input =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}/[0-9]{1,2}$ ]]; then
        IFS='/' read -r ip mask <<< "$input"
        IFS='.' read -r o1 o2 o3 o4 <<< "$ip"
        for octet in $o1 $o2 $o3 $o4; do
            [[ "$octet" -ge 0 && "$octet" -le 255 ]] || return 1
        done
        [[ -z "$mask" || ( "$mask" -ge 0 && "$mask" -le 32 ) ]] || return 1
        return 0
    fi
    return 1
}

# Ensure nmap is installed
command -v nmap >/dev/null 2>&1 || { echo -e "Error: nmap is not installed."; exit 1; }

# Ask for target input
read -rp "Enter an IP address or CIDR range: " TARGET

# Validate input format
if ! validate_ip_or_cidr "$TARGET"; then
    echo -e "Invalid IP address or range format."
    exit 1
fi

# Track start time
START_TIME=$(date +%s)
START_HUMAN=$(date "+%Y-%m-%d %H:%M:%S")

# Create report file
REPORT_FILE="scan_report.txt"
> "$REPORT_FILE"

echo -e "------------------------------------------------"
echo -e "[*] Starting scan on @@@ $TARGET at $START_HUMAN" | tee -a "$REPORT_FILE"

# Scan each service individually, only if port is open
for service in "${SERVICES[@]}"; do
    IFS=':' read -r name port proto scripts <<< "$service"
    echo -e "\n[*] Checking $name ($proto port $port)..." | tee -a "$REPORT_FILE"

    # Basic port check
    if [[ $proto == "TCP" ]]; then
        scan_output=$(nmap -Pn -p "$port" --open "$TARGET" -oG - 2>/dev/null)
    elif [[ $proto == "UDP" ]]; then
        scan_output=$(nmap -sU -Pn -p "$port" --open "$TARGET" -oG - 2>/dev/null)
    else
        echo -e "[!] Unknown protocol: $proto for $name" | tee -a "$REPORT_FILE"
        continue
    fi

    # Check if port is open
    if echo "$scan_output" | grep -q "Ports:.*open"; then
       echo -e "[+] $name port $port is open." | tee -a "$REPORT_FILE"
       if [[ -n "$scripts" ]]; then
       	echo -e "Running scripts: $scripts" | tee -a "$REPORT_FILE"
        echo -e "----- Plugin Output for $name -----" | tee -a "$REPORT_FILE"
        if [[ $proto == "TCP" ]]; then
            nmap -n -sSV -p "$port" --min-rate=1000 --script "$scripts" "$TARGET" -oN temp_result.txt >/dev/null
        else
            nmap -n -sUV -p "$port" --min-rate=1000 --script "$scripts" "$TARGET" -oN temp_result.txt >/dev/null
        fi
        cat temp_result.txt | tee -a "$REPORT_FILE"
    else
        echo -e "No scripts specified. Running version scan only." | tee -a "$REPORT_FILE"
        echo -e "----- Plugin Output for $name -----" | tee -a "$REPORT_FILE"
        if [[ $proto == "TCP" ]]; then
            nmap -n -sSV -p "$port" --min-rate=1000 "$TARGET" -oN temp_result.txt >/dev/null
        else
            nmap -n -sUV -p "$port" --min-rate=1000 "$TARGET" -oN temp_result.txt >/dev/null
        fi
        cat temp_result.txt | tee -a "$REPORT_FILE"
    fi
else
    echo -e "[-] $name port $port is closed or filtered. Skipping." | tee -a "$REPORT_FILE"
fi
done

# Track end time
END_TIME=$(date +%s)
END_HUMAN=$(date "+%Y-%m-%d %H:%M:%S")
DURATION=$((END_TIME - START_TIME))

# Clean up
rm -f temp_result.txt

echo -e "\n[*] Scan complete at $END_HUMAN. Duration: ${DURATION} seconds"
echo "========== Summary =========="
grep -E "^Nmap scan report for|^[0-9]+/(tcp|udp)" "$REPORT_FILE"
echo "============================="

# Add duration to the report file
{
    echo ""
    echo "========== Scan Metadata =========="
    echo "Started at: $START_HUMAN"
    echo "Finished at: $END_HUMAN"
    echo "Total Duration: ${DURATION} seconds"
    echo "==================================="
} >> "$REPORT_FILE"
